USE MODULE_3_CASE_STUDY;
# MySQL STAYWELL SCHEMA

# Create OWNER table
DROP TABLE IF EXISTS OWNER;
CREATE TABLE OWNER (
    OWNER_NUM CHAR(5) PRIMARY KEY NOT NULL,
    LAST_NAME VARCHAR(20) NOT NULL,
    FIRST_NAME VARCHAR(20) NOT NULL,
    ADDRESS VARCHAR(100) NOT NULL,
    CITY VARCHAR(20) NOT NULL,
    STATE CHAR(2) NOT NULL,
    ZIP_CODE CHAR(5) NOT NULL
);

# Insert owners
INSERT INTO OWNER VALUES('MO100','Moore','Elle-May','8006 W. Newport Ave.','Reno','NV','89508');
INSERT INTO OWNER VALUES('PA101','Patel','Makesh','7337 Sheffield St.','Seattle','WA','98119');
INSERT INTO OWNER VALUES('AK102','Aksoy','Ceyda','411 Griffin Rd.','Seattle','WA','98131');
INSERT INTO OWNER VALUES('CO103','Cole','Meerab','9486 Circle Ave.','Olympia','WA','98506');
INSERT INTO OWNER VALUES('KO104','Kowalczyk','Jakub','7431 S. Bishop St.','Bellingham','WA','98226');
INSERT INTO OWNER VALUES('SI105','Sims','Haydon','527 Primrose Rd.','Portland','OR','97203');
INSERT INTO OWNER VALUES('BU106','Burke','Ernest','613 Old Pleasant St.','Twin Falls','ID','83303');
INSERT INTO OWNER VALUES('RE107','Redman','Seth','7681 Fordham St.','Seattle','WA','98119');
INSERT INTO OWNER VALUES('LO108','Lopez','Janine','9856 Pumpkin Hill Ln.','Everett','WA','98213');
INSERT INTO OWNER VALUES('BI109','Bianchi','Nicole','7990 Willow Dr.','New York','NY','10005');
INSERT INTO OWNER VALUES('JO110','Jones','Ammarah','730 Military Ave.','Seattle','WA','98126');


# Create PROPERTY table  
DROP TABLE IF EXISTS PROPERTY;    
CREATE TABLE PROPERTY (
    PROPERTY_ID SMALLINT PRIMARY KEY NOT NULL,
    OFFICE_NUM TINYINT NOT NULL,
    ADDRESS VARCHAR(100) NOT NULL,
    SQR_FT SMALLINT NOT NULL,
    BDRMS TINYINT NOT NULL,
    FLOORS TINYINT NOT NULL,
    MONTHLY_RENT SMALLINT,
    OWNER_NUM CHAR(5) NOT NULL
);

# Insert properties 
INSERT INTO PROPERTY VALUES('1','1','30 West Thomas Rd.','1600','3','1',1400,'BU106');
INSERT INTO PROPERTY VALUES('2','1','782 Queen Ln.','2100','4','2',1900,'AK102');
INSERT INTO PROPERTY VALUES('3','1','9800 Sunbeam Ave.','1005','2','1',1200,'BI109');
INSERT INTO PROPERTY VALUES('4','1','105 North Illinois Rd.','1750','3','1',1650,'KO104');
INSERT INTO PROPERTY VALUES('5','1','887 Vine Rd.','1125','2','1',1160,'SI105');
INSERT INTO PROPERTY VALUES('6','1','8 Laurel Dr.','2125','4','2',2050,'MO100');
INSERT INTO PROPERTY VALUES('7','2','447 Goldfield St.','1675','3','2',1700,'CO103');
INSERT INTO PROPERTY VALUES('8','2','594 Leatherwood Dr.','2700','5','2',2750,'KO104');
INSERT INTO PROPERTY VALUES('9','2','504 Windsor Ave.','700','2','1',1050,'PA101');
INSERT INTO PROPERTY VALUES('10','2','891 Alton Dr.','1300','3','1',1600,'LO108');
INSERT INTO PROPERTY VALUES('11','2','9531 Sherwood Rd.','1075','2','1',1100,'JO110');
INSERT INTO PROPERTY VALUES('12','2','2 Bow Ridge Ave.','1400','3','2',1700,'RE107');


# Create OFFICE table
DROP TABLE IF EXISTS OFFICE;
CREATE TABLE OFFICE (
    OFFICE_NUM TINYINT PRIMARY KEY NOT NULL,
    OFFICE_NAME VARCHAR(50) NOT NULL,
    ADDRESS VARCHAR(100) NOT NULL,
    AREA VARCHAR(50) NOT NULL,
    CITY VARCHAR(20) NOT NULL,
    STATE CHAR(2) NOT NULL,
    ZIP_CODE CHAR(5) NOT NULL
);

# Insert offices 
INSERT INTO OFFICE VALUES('1','StayWell-Colombia City','1135 N. Wells Avenue','Colombia City','Seattle','WA','98118');
INSERT INTO OFFICE VALUES('2','StayWell-Georgetown','986 S. Madison Rd','Georgetown','Seattle','WA','98108');

# Create SERVICE_CATEGORY table 
DROP TABLE IF EXISTS SERVICE_CATEGORY;
CREATE TABLE SERVICE_CATEGORY (
    CATEGORY_NUM TINYINT PRIMARY KEY NOT NULL,
    CATEGORY_DESCRIPTION VARCHAR(100) NOT NULL
);

# Insert service categories
INSERT INTO SERVICE_CATEGORY VALUES('1','Plumbing');
INSERT INTO SERVICE_CATEGORY VALUES('2','Heating');
INSERT INTO SERVICE_CATEGORY VALUES('3','Painting');
INSERT INTO SERVICE_CATEGORY VALUES('4','Electrical Systems');
INSERT INTO SERVICE_CATEGORY VALUES('5','Carpentry');
INSERT INTO SERVICE_CATEGORY VALUES('6','Furniture replacement');

# Create SERVICE_REQUEST table  
DROP TABLE IF EXISTS SERVICE_REQUEST; 
CREATE TABLE SERVICE_REQUEST (
    SERVICE_ID SMALLINT PRIMARY KEY NOT NULL,
    PROPERTY_ID SMALLINT NOT NULL,
    CATEGORY_NUMBER TINYINT NOT NULL,
    OFFICE_ID TINYINT NOT NULL,
    DESCRIPTION VARCHAR(200) NOT NULL,
    STATUS VARCHAR(200) NOT NULL,
    EST_HOURS TINYINT NOT NULL,
    SPENT_HOURS TINYINT NOT NULL,
    NEXT_SERVICE_DATE DATE
);
        
# Insert service requests
INSERT INTO SERVICE_REQUEST VALUES('1','11','2','2','The second bedroom upstairs is not heating up at night.','Problem has been confirmed. central heating engineer has been scheduled. ','2','1','2019-11-01');
INSERT INTO SERVICE_REQUEST VALUES('2','1','4','1','A new strip light is needed for the kitchen.','Scheduled','1','0','2019-10-2');
INSERT INTO SERVICE_REQUEST VALUES('3','6','5','1','The bathroom door does not close properly.','Service rep has confirmed issue. Scheduled to be refitted.','3','1','2019-11-09');
INSERT INTO SERVICE_REQUEST VALUES('4','2','4','1','New outlet has been requested for the first upstairs bedroom. (There is currently no outlet).','Scheduled','1','0','2019-10-02');
INSERT INTO SERVICE_REQUEST VALUES('5','8','3','2','New paint job requested for the common area (lounge). ','Open','10','0',NULL);
INSERT INTO SERVICE_REQUEST VALUES('6','4','1 ','1','Shower is dripping when not in use.','Problem confirmed. Plumber has been scheduled.','4','2','2019-10-07');
INSERT INTO SERVICE_REQUEST VALUES('7','2','2','1','Heating unit in the entrance smells like its burning.','Service rep confirmed the issue to be dust in the heating unit. To be cleaned.  ','1','0','2019-10-09');
INSERT INTO SERVICE_REQUEST VALUES('8','9','1','2','Kitchen sink does not drain properly. ','Problem confirmed. Plumber scheduled.','6','2','2019-11-12');
INSERT INTO SERVICE_REQUEST VALUES('9','12','6','2','New sofa requested.','Open','2','0',NULL);

# Create RESIDENTS  table   
DROP TABLE IF EXISTS RESIDENTS;
CREATE TABLE RESIDENTS (
    RESIDENT_ID SMALLINT PRIMARY KEY NOT NULL,
    FIRST_NAME VARCHAR(20) NOT NULL,
    SURNAME VARCHAR(20) NOT NULL,
    PROPERTY_ID SMALLINT NOT NULL
);

# Insert residents 
INSERT INTO RESIDENTS VALUES('1','Albie ','ORyan','1');
INSERT INTO RESIDENTS VALUES('2','Tariq ','Khan','1');
INSERT INTO RESIDENTS VALUES('3','Ismail ','Salib','1');
INSERT INTO RESIDENTS VALUES('4','Callen ','Beck','2');
INSERT INTO RESIDENTS VALUES('5','Milosz ','Polansky','2');
INSERT INTO RESIDENTS VALUES('6','Ashanti ','Lucas','2');
INSERT INTO RESIDENTS VALUES('7','Randy ','Woodrue','2');
INSERT INTO RESIDENTS VALUES('8','Aislinn ','Lawrence','3');
INSERT INTO RESIDENTS VALUES('9','Monique ','French','3');
INSERT INTO RESIDENTS VALUES('10','Amara ','Dejsuwan','4');
INSERT INTO RESIDENTS VALUES('12','Rosalie ','Blackmore','4');
INSERT INTO RESIDENTS VALUES('13','Carina ','Britton','4');
INSERT INTO RESIDENTS VALUES('14','Valentino ','Ortega','5');
INSERT INTO RESIDENTS VALUES('15','Kaylem ','Kent','5');
INSERT INTO RESIDENTS VALUES('16','Alessia ','Wagner','6');
INSERT INTO RESIDENTS VALUES('17','Tyrone ','Galvan','6');
INSERT INTO RESIDENTS VALUES('18','Constance ','Fleming','6');
INSERT INTO RESIDENTS VALUES('19','Eamonn ','Bain','6');
INSERT INTO RESIDENTS VALUES('20','Misbah ','Yacob','7');
INSERT INTO RESIDENTS VALUES('21','Gianluca ','Esposito','7');
INSERT INTO RESIDENTS VALUES('22','Elinor ','Lake','7');
INSERT INTO RESIDENTS VALUES('23','Ray ','Rosas','8');
INSERT INTO RESIDENTS VALUES('24','Damon ','Caldwell','8');
INSERT INTO RESIDENTS VALUES('25','Dawood ','Busby','8');
INSERT INTO RESIDENTS VALUES('26','Dora ','Harris','8');
INSERT INTO RESIDENTS VALUES('27','Leroy ','Stokes','8');
INSERT INTO RESIDENTS VALUES('28','Tamia ','Hess','9');
INSERT INTO RESIDENTS VALUES('29','Amelia ','Sanders','9');
INSERT INTO RESIDENTS VALUES('30','Zarah ','Byers','10');
INSERT INTO RESIDENTS VALUES('31','Sara ','Farrow','10');
INSERT INTO RESIDENTS VALUES('32','Delilah ','Roy','10');
INSERT INTO RESIDENTS VALUES('33','Dougie ','McDaniel','11');
INSERT INTO RESIDENTS VALUES('34','Tahir ','Halabi','11');
INSERT INTO RESIDENTS VALUES('35','Mila ','Zhikin','12');
INSERT INTO RESIDENTS VALUES('36','Glenn ','Donovan','12');
INSERT INTO RESIDENTS VALUES('37','Zayn ','Fowler','12');

# MODULE 8 QUERIES (QUESTIONS 1 - 5)
USE MODULE_3_CASE_STUDY;

# NUMBER 1
SELECT OWNER_NUM, UPPER(FIRST_NAME) AS FIRST_NAME, LOWER(LAST_NAME) AS LAST_NAME
	FROM OWNER
    ORDER BY OWNER_NUM;
    
# NUMBER 2
SELECT OWNER_NUM, LAST_NAME, CITY
	FROM OWNER
    WHERE UPPER(CITY)='SEATTLE';
    
# NUMBER 3
SELECT P.OFFICE_NUM, P.ADDRESS, O.OWNER_NUM, O.LAST_NAME, P. MONTHLY_RENT, ROUND(MONTHLY_RENT * (1.75/100), 0) AS DISCOUNT
	FROM PROPERTY P, OWNER O
    WHERE (P.OWNER_NUM = O.OWNER_NUM)
    ORDER BY OFFICE_NUM; 
    
# NUMBER 4A
DELIMITER //
CREATE PROCEDURE GET_OWNER_NAME (IN I_OWNER_NUM CHAR(5))
BEGIN
	DECLARE I_FIRST_NAME VARCHAR(10); 
    DECLARE I_LAST_NAME VARCHAR(15); 
    DECLARE EXIT HANDLER FOR NOT FOUND
		SELECT CONCAT ('No owner with this number was found:', I_OWNER_NUM) AS MESSAGE;
	
    SELECT FIRST_NAME, LAST_NAME
		INTO I_FIRST_NAME, I_LAST_NAME
	FROM OWNER
		WHERE OWNER_NUM = I_OWNER_NUM; 
	
    SELECT I_FIRST_NAME, I_LAST_NAME; 
END //

DELIMITER ;
CALL GET_OWNER_NAME('AK102');

# NUMBER 4B
DELIMITER //
CREATE PROCEDURE GET_PROPERTY_DETAILS (IN I_PROPERTY_ID CHAR(2))
BEGIN
	DECLARE I_LOCATION_NUM VARCHAR(1); 
    DECLARE I_ADDRESS VARCHAR(30); 
    DECLARE I_OWNER_NUM VARCHAR(5); 
    DECLARE I_FIRST_NAME VARCHAR(10); 
    DECLARE I_LAST_NAME VARCHAR(15); 
    DECLARE EXIT HANDLER FOR NOT FOUND
		SELECT CONCAT ('No property with this ID was found:', I_PROPERTY_ID) AS MESSAGE; 
	
    SELECT P.OFFICE_NUM, P.ADDRESS, O.OWNER_NUM, O.FIRST_NAME, O.LAST_NAME
		INTO I_LOCATION_NUM, I_ADDRESS, I_OWNER_NUM, I_FIRST_NAME, I_LAST_NAME
	FROM PROPERTY P, OWNER O
        WHERE (P.OWNER_NUM = O.OWNER_NUM) AND P.PROPERTY_ID = I_PROPERTY_ID; 
        
	SELECT I_LOCATION_NUM, I_ADDRESS, I_OWNER_NUM, I_FIRST_NAME, I_LAST_NAME; 
END //

DELIMITER ;
CALL GET_PROPERTY_DETAILS('1');

# NUMBER 4C
DELIMITER //
CREATE PROCEDURE INSERT_ROW_OWNER (IN OWNER_NUM CHAR(5), IN LAST_NAME VARCHAR(10), IN FIRST_NAME VARCHAR(10), IN ADDRESS VARCHAR(35), IN CITY VARCHAR(10), IN STATE VARCHAR(2), IN ZIP_CODE VARCHAR(5))
BEGIN
	INSERT INTO OWNER VALUES (OWNER_NUM, LAST_NAME, FIRST_NAME, ADDRESS, CITY, STATE, ZIP_CODE); 
END //

DELIMITER ;
CALL INSERT_ROW_OWNER('JS110', 'Smith', 'John', '424 Appleseed Drive', 'Bellevue', 'WA', '98133'); 
SELECT*
	FROM OWNER; 
    
# NUMBER 4D
DELIMITER //
CREATE PROCEDURE CHANGE_OWNER_LAST (IN I_OWNER_NUM CHAR(5), IN I_NEW_NAME VARCHAR(15))
BEGIN
	DECLARE EXIT HANDLER FOR NOT FOUND
		SELECT CONCAT ('No owner with this number was found:', I_OWNER_NUM) AS MESSAGE; 
	UPDATE OWNER
		SET LAST_NAME = I_NEW_NAME
        WHERE OWNER_NUM = I_OWNER_NUM; 
END //

DELIMITER ; 
CALL CHANGE_OWNER_LAST('AK102', 'Smith'); 
SELECT*
	FROM OWNER 
    WHERE OWNER_NUM = 'AK102';
    
# NUMBER 4E
DELIMITER //
CREATE PROCEDURE DELETE_OWNER (IN I_OWNER_NUM CHAR(5))
BEGIN
	DECLARE EXIT HANDLER FOR NOT FOUND
		SELECT CONCAT ('No owner with this number was found:', I_OWNER_NUM) AS MESSAGE; 
	
    DELETE FROM OWNER
		WHERE OWNER_NUM = I_OWNER_NUM; 
END //

DELIMITER ;
CALL DELETE_OWNER('BU106');

# NUMBER 5
DELIMITER //
CREATE PROCEDURE DISPLAY_PROPERTY_DETAILS (IN I_SQR_FT DECIMAL(5, 0))
BEGIN
	DECLARE DONE INT DEFAULT FALSE; 
    DECLARE I_OFFICE_NUM CHAR(1); 
    DECLARE I_ADDRESS VARCHAR(30); 
    DECLARE I_MONTHLY_RENT CHAR(4); 
    DECLARE I_OWNER_NUM VARCHAR(5); 
    DECLARE PROPDETAILS CURSOR FOR 
		SELECT OFFICE_NUM, ADDRESS, MONTHLY_RENT, OWNER_NUM
			FROM PROPERTY
            WHERE SQR_FT = I_SQR_FT; 
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = TRUE; 
    
    OPEN PROPDETAILS; 
    READ_LOOP: LOOP
		FETCH PROPDETAILS INTO I_OFFICE_NUM, I_ADDRESS, I_MONTHLY_RENT, I_OWNER_NUM; 
        IF DONE THEN
			LEAVE READ_LOOP; 
		END IF; 
        SELECT I_OFFICE_NUM, I_ADDRESS, I_MONTHLY_RENT, I_OWNER_NUM; 
	END LOOP; 
    CLOSE PROPDETAILS; 
END //

DELIMITER ;
DROP PROCEDURE DISPLAY_PROPERTY_DETAILS; 
CALL DISPLAY_PROPERTY_DETAILS('1600');